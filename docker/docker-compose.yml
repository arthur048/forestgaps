# ============================================
# ForestGaps Docker Compose Configuration
# ============================================

services:
  # =========================================
  # Service principal ForestGaps (base, sans ports)
  # =========================================
  forestgaps:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: forestgaps:latest
    container_name: forestgaps-main
    command: tail -f /dev/null

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 32G

    environment:
      - NVIDIA_VISIBLE_DEVICES=0
      - CUDA_VISIBLE_DEVICES=0
      - CUDA_DEVICE_ORDER=PCI_BUS_ID
      - PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512
      - OMP_NUM_THREADS=8
      - MKL_NUM_THREADS=8
      - NUMEXPR_NUM_THREADS=8
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - FORESTGAPS_ENV=docker
      - LOG_LEVEL=INFO

    volumes:
      - ../data:/app/data:rws
      - ../models:/app/models:rw
      - ../outputs:/app/outputs:rw
      - ../logs:/app/logs:rw

    shm_size: '8gb'
    stdin_open: true
    tty: true

    healthcheck:
      test: ["CMD", "python", "/app/healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================
  # Jupyter Lab
  # =========================================
  jupyter:
    image: forestgaps:latest
    container_name: forestgaps-jupyter
    depends_on:
      - forestgaps
    command: >
      jupyter lab 
      --ip=0.0.0.0 
      --port=8888 
      --no-browser 
      --allow-root
      --ServerApp.token=''
      --ServerApp.password=''
    ports:
      - "8888:8888"
    volumes:
      - ../data:/app/data:ro
      - ../models:/app/models:rw
      - ../outputs:/app/outputs:rw
      - ../logs:/app/logs:rw
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
      - CUDA_VISIBLE_DEVICES=0
    shm_size: '8gb'
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # =========================================
  # TensorBoard
  # =========================================
  tensorboard:
    image: forestgaps:latest
    container_name: forestgaps-tensorboard
    depends_on:
      - forestgaps
    command: tensorboard --logdir=/app/logs --bind_all
    ports:
      - "6006:6006"
    volumes:
      - ../logs:/app/logs:ro
    restart: unless-stopped

# ============================================
# Usage:
#   docker-compose build  #construire l'image
#   docker-compose up -d          # Tout lancer
#   docker-compose up jupyter tensorboard  # Les deux services
#   docker-compose run --rm forestgaps bash  # Shell
# ============================================